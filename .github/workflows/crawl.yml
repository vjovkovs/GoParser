name: Crawl

on:
  workflow_dispatch:
    inputs:
      start_url:
        description: "Start URL"
        required: true
        default: "https://wanderinginn.com/2020/04/19/interlude-strategists-at-sea-pt-1/"
      max_pages:
        description: "Max pages to crawl"
        required: true
        default: "1"
      user_agent:
        description: "Optional custom User-Agent"
        required: false
        default: "Go-Parser/1.0 (+https://github.com/vjovkovs/goparser)"
      fmt:
        description: "Final artifact format: epub|pdf|txt|none"
        required: true
        default: "txt"
      title:
        description: "Book title (required if fmt != none)"
        required: false
        default: "The Wandering Inn"
      author:
        description: "Author (optional)"
        required: false
        default: "PirateAba"
      chapter_fmt:
        description: "Per-chapter formats (comma-separated: epub,pdf,txt)"
        required: false
        default: "txt"
      out_dir:
        description: "Output directory"
        required: true
        default: "out"

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build crawler
        run: |
          go build -o bin/gwp ./cmd/gwp

      - name: Run crawler
        env:
          START_URL: ${{ inputs.start_url }}
          MAX: ${{ inputs.max_pages }}
          UA: ${{ inputs.user_agent }}
          FMT: ${{ inputs.fmt }}
          TITLE: ${{ inputs.title }}
          AUTHOR: ${{ inputs.author }}
          OUTDIR: ${{ inputs.out_dir }}
          CHAPTERFMT: ${{ inputs.chapter_fmt }}
        run: |
          mkdir -p "$OUTDIR"
          ARGS=( "--url=$START_URL" "--max=$MAX" "--out=$OUTDIR" )
          if [ -n "$UA" ]; then ARGS+=( "--ua=$UA" ); fi
          if [ -n "$FMT" ]; then ARGS+=( "--fmt=$FMT" ); fi
          if [ -n "$TITLE" ]; then ARGS+=( "--title=$TITLE" ); fi
          if [ -n "$AUTHOR" ]; then ARGS+=( "--author=$AUTHOR" ); fi
          if [ -n "$CHAPTERFMT" ]; then ARGS+=( "--chapter-fmt=$CHAPTERFMT" ); fi
          ./bin/gwp "${ARGS[@]}"

      - name: Upload crawl artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crawl-output-${{ github.run_id }}
          path: ${{ inputs.out_dir }}/**
          if-no-files-found: error
